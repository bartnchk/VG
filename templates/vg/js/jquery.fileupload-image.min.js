"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e){"function"==typeof define&&define.amd?define(["jquery","load-image","load-image-meta","load-image-scale","load-image-exif","canvas-to-blob","./jquery.fileupload-process"],e):"object"===("undefined"==typeof exports?"undefined":_typeof(exports))?e(require("jquery"),require("blueimp-load-image/js/load-image"),require("blueimp-load-image/js/load-image-meta"),require("blueimp-load-image/js/load-image-scale"),require("blueimp-load-image/js/load-image-exif"),require("blueimp-canvas-to-blob"),require("./jquery.fileupload-process")):e(window.jQuery,window.loadImage)}(function(e,i){e.blueimp.fileupload.prototype.options.processQueue.unshift({action:"loadImageMetaData",disableImageHead:"@",disableExif:"@",disableExifThumbnail:"@",disableExifSub:"@",disableExifGps:"@",disabled:"@disableImageMetaDataLoad"},{action:"loadImage",prefix:!0,fileTypes:"@",maxFileSize:"@",noRevoke:"@",disabled:"@disableImageLoad"},{action:"resizeImage",prefix:"image",maxWidth:"@",maxHeight:"@",minWidth:"@",minHeight:"@",crop:"@",orientation:"@",forceResize:"@",disabled:"@disableImageResize"},{action:"saveImage",quality:"@imageQuality",type:"@imageType",disabled:"@disableImageResize"},{action:"saveImageMetaData",disabled:"@disableImageMetaDataSave"},{action:"resizeImage",prefix:"preview",maxWidth:"@",maxHeight:"@",minWidth:"@",minHeight:"@",crop:"@",orientation:"@",thumbnail:"@",canvas:"@",disabled:"@disableImagePreview"},{action:"setImage",name:"@imagePreviewName",disabled:"@disableImagePreview"},{action:"deleteImageReferences",disabled:"@disableImageReferencesDeletion"}),e.widget("blueimp.fileupload",e.blueimp.fileupload,{options:{loadImageFileTypes:/^image\/(gif|jpeg|png|svg\+xml)$/,loadImageMaxFileSize:1e7,imageMaxWidth:1920,imageMaxHeight:1080,imageOrientation:!1,imageCrop:!1,disableImageResize:!0,previewMaxWidth:80,previewMaxHeight:80,previewOrientation:!0,previewThumbnail:!0,previewCrop:!1,previewCanvas:!0},processActions:{loadImage:function(a,t){if(t.disabled)return a;var n=this,o=a.files[a.index],r=e.Deferred();return"number"===e.type(t.maxFileSize)&&o.size>t.maxFileSize||t.fileTypes&&!t.fileTypes.test(o.type)||!i(o,function(e){e.src&&(a.img=e),r.resolveWith(n,[a])},t)?a:r.promise()},resizeImage:function(a,t){if(t.disabled||!a.canvas&&!a.img)return a;t=e.extend({canvas:!0},t);var n,o=this,r=e.Deferred(),l=t.canvas&&a.canvas||a.img,s=function(e){e&&(e.width!==l.width||e.height!==l.height||t.forceResize)&&(a[e.getContext?"canvas":"img"]=e),a.preview=e,r.resolveWith(o,[a])};if(a.exif){if(!0===t.orientation&&(t.orientation=a.exif.get("Orientation")),t.thumbnail&&(n=a.exif.get("Thumbnail")))return i(n,s,t),r.promise();a.orientation?delete t.orientation:a.orientation=t.orientation}return l?(s(i.scale(l,t)),r.promise()):a},saveImage:function(i,a){if(!i.canvas||a.disabled)return i;var t=this,n=i.files[i.index],o=e.Deferred();return i.canvas.toBlob?(i.canvas.toBlob(function(e){e.name||(n.type===e.type?e.name=n.name:n.name&&(e.name=n.name.replace(/\.\w+$/,"."+e.type.substr(6)))),n.type!==e.type&&delete i.imageHead,i.files[i.index]=e,o.resolveWith(t,[i])},a.type||n.type,a.quality),o.promise()):i},loadImageMetaData:function(a,t){if(t.disabled)return a;var n=this,o=e.Deferred();return i.parseMetaData(a.files[a.index],function(i){e.extend(a,i),o.resolveWith(n,[a])},t),o.promise()},saveImageMetaData:function(e,i){if(!(e.imageHead&&e.canvas&&e.canvas.toBlob)||i.disabled)return e;var a=e.files[e.index],t=new Blob([e.imageHead,this._blobSlice.call(a,20)],{type:a.type});return t.name=a.name,e.files[e.index]=t,e},setImage:function(e,i){return e.preview&&!i.disabled&&(e.files[e.index][i.name||"preview"]=e.preview),e},deleteImageReferences:function(e,i){return i.disabled||(delete e.img,delete e.canvas,delete e.preview,delete e.imageHead),e}}})});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpxdWVyeS5maWxldXBsb2FkLWltYWdlLmpzIl0sIm5hbWVzIjpbImZhY3RvcnkiLCJkZWZpbmUiLCJhbWQiLCJleHBvcnRzIiwiX3R5cGVvZiIsInJlcXVpcmUiLCJsb2FkSW1hZ2UiLCJibHVlaW1wIiwiZmlsZXVwbG9hZCIsImRpc2FibGVFeGlmVGh1bWJuYWlsIiwiZGlzYWJsZUV4aWZTdWIiLCJkaXNhYmxlRXhpZkdwcyIsImFjdGlvbiIsIm1heEZpbGVTaXplIiwicHJvdG90eXBlIiwib3B0aW9ucyIsInByb2Nlc3NRdWV1ZSIsInVuc2hpZnQiLCJkaXNhYmxlZCIsImRpc2FibGVJbWFnZUhlYWQiLCJwcmVmaXgiLCJtYXhXaWR0aCIsIm1heEhlaWdodCIsImNyb3AiLCJmb3JjZVJlc2l6ZSIsInF1YWxpdHkiLCJtaW5XaWR0aCIsIm1pbkhlaWdodCIsInRodW1ibmFpbCIsImNhbnZhcyIsIm9yaWVudGF0aW9uIiwibG9hZEltYWdlRmlsZVR5cGVzIiwibG9hZEltYWdlTWF4RmlsZVNpemUiLCJpbWFnZU1heEhlaWdodCIsImltYWdlQ3JvcCIsInByZXZpZXdNYXhIZWlnaHQiLCIkIiwicHJldmlld1RodW1ibmFpbCIsInByZXZpZXdDcm9wIiwicHJldmlld0NhbnZhcyIsImltYWdlT3JpZW50YXRpb24iLCJwcmV2aWV3TWF4V2lkdGgiLCJkYXRhIiwicHJldmlld09yaWVudGF0aW9uIiwiaW1nIiwiZGZkIiwicmVzb2x2ZVdpdGgiLCJwcm9jZXNzQWN0aW9ucyIsInJlc2l6ZUltYWdlIiwidGhhdCIsInRoaXMiLCJleHRlbmQiLCJEZWZlcnJlZCIsInJlc29sdmUiLCJmaWxlVHlwZXMiLCJuZXdJbWciLCJ0ZXN0Iiwid2lkdGgiLCJmaWxlIiwicHJldmlldyIsInNyYyIsInByb21pc2UiLCJoZWlnaHQiLCJnZXRDb250ZXh0IiwidG9CbG9iIiwiZXhpZiIsImdldCIsImJsb2IiLCJuYW1lIiwic2NhbGUiLCJ0eXBlIiwic2F2ZUltYWdlIiwicGFyc2VNZXRhRGF0YSIsInJlcGxhY2UiLCJpbmRleCIsInN1YnN0ciIsImZpbGVzIiwiZGVsZXRlSW1hZ2VSZWZlcmVuY2VzIiwibG9hZEltYWdlTWV0YURhdGEiLCJyZXN1bHQiLCJzYXZlSW1hZ2VNZXRhRGF0YSIsImltYWdlSGVhZCIsIkJsb2IiLCJfYmxvYlNsaWNlIiwiY2FsbCIsInNldEltYWdlIl0sIm1hcHBpbmdzIjoib09BY0UsU0FBVUEsR0FGWixrQkFBQUMsU0FBQUEsT0FBQUMsSUFFRUQsUUFDRSxTQUtRLGFBSkosa0JBQ0EsbUJBQ0FBLGtCQVNHLGlCQUNILCtCQUNBRCxHQVNHLFlBQUEsbUJBQUFHLFNBQUEsWUFBQUMsUUFBQUQsVUFFSEgsRUFJSEssUUFBQSxVQUNIQSxRQUFhQyxvQ0FDWEQsUUFBQSx5Q0FiUUEsUUFBUSwwQ0FlaEJBLFFBQUEseUNBYlFBLFFBQVEsMEJBY2RFLFFBQVFDLGdDQUtGQyxFQUNBQyxPQUFBQSxPQUNBQyxPQUFBQSxZQUlBQyxTQUFBQSxFQUFBQSxHQUlBQyxFQUFBQSxRQUFBQSxXQUxKQyxVQUFBQyxRQUFBQyxhQUFBQyxTQU9JQyxPQUFVLG9CQUVkQyxpQkFBQSxJQUNJUCxZQUFRLElBQ1JILHFCQUFBLElBQ0FXLGVBSEosSUFJSUMsZUFKSixJQUtJQyxTQUxKLDhCQVFJQyxPQVJKLFlBVUlDLFFBQUFBLEVBQ0FOLFVBQVUsSUFFZEwsWUFBQSxJQUNJRCxTQUFRLElBQ1JhLFNBQVMsc0JBSWJiLE9BQUEsY0FFSU0sT0FBVSxRQUVkRyxTQUFBLElBQ0lULFVBQVEsSUFDUmMsU0FBQSxJQUNBTixVQUFRLElBQ1JDLEtBQVUsSUFDVkMsWUFMSixJQU1JSSxZQU5KLElBT0lDLFNBUEosd0JBVUlDLE9BQVcsWUFDWEMsUUFYSixnQkFZSVgsS0FBVSxhQUVkQSxTQUFBLHdCQUdJQSxPQUFVLG9CQUVkQSxTQUFBLDhCQTdESk4sT0FBQSxjQW1FQVEsT0FBQSxVQUNBQyxTQUFBLElBQ0FDLFVBQVMsSUFyQkRJLFNBQVUsSUF1QmRYLFVBQVMsSUFDTFEsS0FBQSxJ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dWVyeSBGaWxlIFVwbG9hZCBJbWFnZSBQcmV2aWV3ICYgUmVzaXplIFBsdWdpblxuICogaHR0cHM6Ly9naXRodWIuY29tL2JsdWVpbXAvalF1ZXJ5LUZpbGUtVXBsb2FkXG4gKlxuICogQ29weXJpZ2h0IDIwMTMsIFNlYmFzdGlhbiBUc2NoYW5cbiAqIGh0dHBzOi8vYmx1ZWltcC5uZXRcbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2U6XG4gKiBodHRwczovL29wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL01JVFxuICovXG5cbi8qIGpzaGludCBub21lbjpmYWxzZSAqL1xuLyogZ2xvYmFsIGRlZmluZSwgcmVxdWlyZSwgd2luZG93LCBCbG9iICovXG5cbjsoZnVuY3Rpb24gKGZhY3RvcnkpIHtcbiAgICAndXNlIHN0cmljdCc7XG4gICAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkge1xuICAgICAgICAvLyBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgQU1EIG1vZHVsZTpcbiAgICAgICAgZGVmaW5lKFtcbiAgICAgICAgICAgICdqcXVlcnknLFxuICAgICAgICAgICAgJ2xvYWQtaW1hZ2UnLFxuICAgICAgICAgICAgJ2xvYWQtaW1hZ2UtbWV0YScsXG4gICAgICAgICAgICAnbG9hZC1pbWFnZS1zY2FsZScsXG4gICAgICAgICAgICAnbG9hZC1pbWFnZS1leGlmJyxcbiAgICAgICAgICAgICdjYW52YXMtdG8tYmxvYicsXG4gICAgICAgICAgICAnLi9qcXVlcnkuZmlsZXVwbG9hZC1wcm9jZXNzJ1xuICAgICAgICBdLCBmYWN0b3J5KTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0Jykge1xuICAgICAgICAvLyBOb2RlL0NvbW1vbkpTOlxuICAgICAgICBmYWN0b3J5KFxuICAgICAgICAgICAgcmVxdWlyZSgnanF1ZXJ5JyksXG4gICAgICAgICAgICByZXF1aXJlKCdibHVlaW1wLWxvYWQtaW1hZ2UvanMvbG9hZC1pbWFnZScpLFxuICAgICAgICAgICAgcmVxdWlyZSgnYmx1ZWltcC1sb2FkLWltYWdlL2pzL2xvYWQtaW1hZ2UtbWV0YScpLFxuICAgICAgICAgICAgcmVxdWlyZSgnYmx1ZWltcC1sb2FkLWltYWdlL2pzL2xvYWQtaW1hZ2Utc2NhbGUnKSxcbiAgICAgICAgICAgIHJlcXVpcmUoJ2JsdWVpbXAtbG9hZC1pbWFnZS9qcy9sb2FkLWltYWdlLWV4aWYnKSxcbiAgICAgICAgICAgIHJlcXVpcmUoJ2JsdWVpbXAtY2FudmFzLXRvLWJsb2InKSxcbiAgICAgICAgICAgIHJlcXVpcmUoJy4vanF1ZXJ5LmZpbGV1cGxvYWQtcHJvY2VzcycpXG4gICAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgLy8gQnJvd3NlciBnbG9iYWxzOlxuICAgICAgICBmYWN0b3J5KFxuICAgICAgICAgICAgd2luZG93LmpRdWVyeSxcbiAgICAgICAgICAgIHdpbmRvdy5sb2FkSW1hZ2VcbiAgICAgICAgKTtcbiAgICB9XG59KGZ1bmN0aW9uICgkLCBsb2FkSW1hZ2UpIHtcbiAgICAndXNlIHN0cmljdCc7XG5cbiAgICAvLyBQcmVwZW5kIHRvIHRoZSBkZWZhdWx0IHByb2Nlc3NRdWV1ZTpcbiAgICAkLmJsdWVpbXAuZmlsZXVwbG9hZC5wcm90b3R5cGUub3B0aW9ucy5wcm9jZXNzUXVldWUudW5zaGlmdChcbiAgICAgICAge1xuICAgICAgICAgICAgYWN0aW9uOiAnbG9hZEltYWdlTWV0YURhdGEnLFxuICAgICAgICAgICAgZGlzYWJsZUltYWdlSGVhZDogJ0AnLFxuICAgICAgICAgICAgZGlzYWJsZUV4aWY6ICdAJyxcbiAgICAgICAgICAgIGRpc2FibGVFeGlmVGh1bWJuYWlsOiAnQCcsXG4gICAgICAgICAgICBkaXNhYmxlRXhpZlN1YjogJ0AnLFxuICAgICAgICAgICAgZGlzYWJsZUV4aWZHcHM6ICdAJyxcbiAgICAgICAgICAgIGRpc2FibGVkOiAnQGRpc2FibGVJbWFnZU1ldGFEYXRhTG9hZCdcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgICAgYWN0aW9uOiAnbG9hZEltYWdlJyxcbiAgICAgICAgICAgIC8vIFVzZSB0aGUgYWN0aW9uIGFzIHByZWZpeCBmb3IgdGhlIFwiQFwiIG9wdGlvbnM6XG4gICAgICAgICAgICBwcmVmaXg6IHRydWUsXG4gICAgICAgICAgICBmaWxlVHlwZXM6ICdAJyxcbiAgICAgICAgICAgIG1heEZpbGVTaXplOiAnQCcsXG4gICAgICAgICAgICBub1Jldm9rZTogJ0AnLFxuICAgICAgICAgICAgZGlzYWJsZWQ6ICdAZGlzYWJsZUltYWdlTG9hZCdcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgICAgYWN0aW9uOiAncmVzaXplSW1hZ2UnLFxuICAgICAgICAgICAgLy8gVXNlIFwiaW1hZ2VcIiBhcyBwcmVmaXggZm9yIHRoZSBcIkBcIiBvcHRpb25zOlxuICAgICAgICAgICAgcHJlZml4OiAnaW1hZ2UnLFxuICAgICAgICAgICAgbWF4V2lkdGg6ICdAJyxcbiAgICAgICAgICAgIG1heEhlaWdodDogJ0AnLFxuICAgICAgICAgICAgbWluV2lkdGg6ICdAJyxcbiAgICAgICAgICAgIG1pbkhlaWdodDogJ0AnLFxuICAgICAgICAgICAgY3JvcDogJ0AnLFxuICAgICAgICAgICAgb3JpZW50YXRpb246ICdAJyxcbiAgICAgICAgICAgIGZvcmNlUmVzaXplOiAnQCcsXG4gICAgICAgICAgICBkaXNhYmxlZDogJ0BkaXNhYmxlSW1hZ2VSZXNpemUnXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICAgIGFjdGlvbjogJ3NhdmVJbWFnZScsXG4gICAgICAgICAgICBxdWFsaXR5OiAnQGltYWdlUXVhbGl0eScsXG4gICAgICAgICAgICB0eXBlOiAnQGltYWdlVHlwZScsXG4gICAgICAgICAgICBkaXNhYmxlZDogJ0BkaXNhYmxlSW1hZ2VSZXNpemUnXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICAgIGFjdGlvbjogJ3NhdmVJbWFnZU1ldGFEYXRhJyxcbiAgICAgICAgICAgIGRpc2FibGVkOiAnQGRpc2FibGVJbWFnZU1ldGFEYXRhU2F2ZSdcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgICAgYWN0aW9uOiAncmVzaXplSW1hZ2UnLFxuICAgICAgICAgICAgLy8gVXNlIFwicHJldmlld1wiIGFzIHByZWZpeCBmb3IgdGhlIFwiQFwiIG9wdGlvbnM6XG4gICAgICAgICAgICBwcmVmaXg6ICdwcmV2aWV3JyxcbiAgICAgICAgICAgIG1heFdpZHRoOiAnQCcsXG4gICAgICAgICAgICBtYXhIZWlnaHQ6ICdAJyxcbiAgICAgICAgICAgIG1pbldpZHRoOiAnQCcsXG4gICAgICAgICAgICBtaW5IZWlnaHQ6ICdAJyxcbiAgICAgICAgICAgIGNyb3A6ICdAJyxcbiAgICAgICAgICAgIG9yaWVudGF0aW9uOiAnQCcsXG4gICAgICAgICAgICB0aHVtYm5haWw6ICdAJyxcbiAgICAgICAgICAgIGNhbnZhczogJ0AnLFxuICAgICAgICAgICAgZGlzYWJsZWQ6ICdAZGlzYWJsZUltYWdlUHJldmlldydcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgICAgYWN0aW9uOiAnc2V0SW1hZ2UnLFxuICAgICAgICAgICAgbmFtZTogJ0BpbWFnZVByZXZpZXdOYW1lJyxcbiAgICAgICAgICAgIGRpc2FibGVkOiAnQGRpc2FibGVJbWFnZVByZXZpZXcnXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICAgIGFjdGlvbjogJ2RlbGV0ZUltYWdlUmVmZXJlbmNlcycsXG4gICAgICAgICAgICBkaXNhYmxlZDogJ0BkaXNhYmxlSW1hZ2VSZWZlcmVuY2VzRGVsZXRpb24nXG4gICAgICAgIH1cbiAgICApO1xuXG4gICAgLy8gVGhlIEZpbGUgVXBsb2FkIFJlc2l6ZSBwbHVnaW4gZXh0ZW5kcyB0aGUgZmlsZXVwbG9hZCB3aWRnZXRcbiAgICAvLyB3aXRoIGltYWdlIHJlc2l6ZSBmdW5jdGlvbmFsaXR5OlxuICAgICQud2lkZ2V0KCdibHVlaW1wLmZpbGV1cGxvYWQnLCAkLmJsdWVpbXAuZmlsZXVwbG9hZCwge1xuXG4gICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICAgIC8vIFRoZSByZWd1bGFyIGV4cHJlc3Npb24gZm9yIHRoZSB0eXBlcyBvZiBpbWFnZXMgdG8gbG9hZDpcbiAgICAgICAgICAgIC8vIG1hdGNoZWQgYWdhaW5zdCB0aGUgZmlsZSB0eXBlOlxuICAgICAgICAgICAgbG9hZEltYWdlRmlsZVR5cGVzOiAvXmltYWdlXFwvKGdpZnxqcGVnfHBuZ3xzdmdcXCt4bWwpJC8sXG4gICAgICAgICAgICAvLyBUaGUgbWF4aW11bSBmaWxlIHNpemUgb2YgaW1hZ2VzIHRvIGxvYWQ6XG4gICAgICAgICAgICBsb2FkSW1hZ2VNYXhGaWxlU2l6ZTogMTAwMDAwMDAsIC8vIDEwTUJcbiAgICAgICAgICAgIC8vIFRoZSBtYXhpbXVtIHdpZHRoIG9mIHJlc2l6ZWQgaW1hZ2VzOlxuICAgICAgICAgICAgaW1hZ2VNYXhXaWR0aDogMTkyMCxcbiAgICAgICAgICAgIC8vIFRoZSBtYXhpbXVtIGhlaWdodCBvZiByZXNpemVkIGltYWdlczpcbiAgICAgICAgICAgIGltYWdlTWF4SGVpZ2h0OiAxMDgwLFxuICAgICAgICAgICAgLy8gRGVmaW5lcyB0aGUgaW1hZ2Ugb3JpZW50YXRpb24gKDEtOCkgb3IgdGFrZXMgdGhlIG9yaWVudGF0aW9uXG4gICAgICAgICAgICAvLyB2YWx1ZSBmcm9tIEV4aWYgZGF0YSBpZiBzZXQgdG8gdHJ1ZTpcbiAgICAgICAgICAgIGltYWdlT3JpZW50YXRpb246IGZhbHNlLFxuICAgICAgICAgICAgLy8gRGVmaW5lIGlmIHJlc2l6ZWQgaW1hZ2VzIHNob3VsZCBiZSBjcm9wcGVkIG9yIG9ubHkgc2NhbGVkOlxuICAgICAgICAgICAgaW1hZ2VDcm9wOiBmYWxzZSxcbiAgICAgICAgICAgIC8vIERpc2FibGUgdGhlIHJlc2l6ZSBpbWFnZSBmdW5jdGlvbmFsaXR5IGJ5IGRlZmF1bHQ6XG4gICAgICAgICAgICBkaXNhYmxlSW1hZ2VSZXNpemU6IHRydWUsXG4gICAgICAgICAgICAvLyBUaGUgbWF4aW11bSB3aWR0aCBvZiB0aGUgcHJldmlldyBpbWFnZXM6XG4gICAgICAgICAgICBwcmV2aWV3TWF4V2lkdGg6IDgwLFxuICAgICAgICAgICAgLy8gVGhlIG1heGltdW0gaGVpZ2h0IG9mIHRoZSBwcmV2aWV3IGltYWdlczpcbiAgICAgICAgICAgIHByZXZpZXdNYXhIZWlnaHQ6IDgwLFxuICAgICAgICAgICAgLy8gRGVmaW5lcyB0aGUgcHJldmlldyBvcmllbnRhdGlvbiAoMS04KSBvciB0YWtlcyB0aGUgb3JpZW50YXRpb25cbiAgICAgICAgICAgIC8vIHZhbHVlIGZyb20gRXhpZiBkYXRhIGlmIHNldCB0byB0cnVlOlxuICAgICAgICAgICAgcHJldmlld09yaWVudGF0aW9uOiB0cnVlLFxuICAgICAgICAgICAgLy8gQ3JlYXRlIHRoZSBwcmV2aWV3IHVzaW5nIHRoZSBFeGlmIGRhdGEgdGh1bWJuYWlsOlxuICAgICAgICAgICAgcHJldmlld1RodW1ibmFpbDogdHJ1ZSxcbiAgICAgICAgICAgIC8vIERlZmluZSBpZiBwcmV2aWV3IGltYWdlcyBzaG91bGQgYmUgY3JvcHBlZCBvciBvbmx5IHNjYWxlZDpcbiAgICAgICAgICAgIHByZXZpZXdDcm9wOiBmYWxzZSxcbiAgICAgICAgICAgIC8vIERlZmluZSBpZiBwcmV2aWV3IGltYWdlcyBzaG91bGQgYmUgcmVzaXplZCBhcyBjYW52YXMgZWxlbWVudHM6XG4gICAgICAgICAgICBwcmV2aWV3Q2FudmFzOiB0cnVlXG4gICAgICAgIH0sXG5cbiAgICAgICAgcHJvY2Vzc0FjdGlvbnM6IHtcblxuICAgICAgICAgICAgLy8gTG9hZHMgdGhlIGltYWdlIGdpdmVuIHZpYSBkYXRhLmZpbGVzIGFuZCBkYXRhLmluZGV4XG4gICAgICAgICAgICAvLyBhcyBpbWcgZWxlbWVudCwgaWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMgdGhlIEZpbGUgQVBJLlxuICAgICAgICAgICAgLy8gQWNjZXB0cyB0aGUgb3B0aW9ucyBmaWxlVHlwZXMgKHJlZ3VsYXIgZXhwcmVzc2lvbilcbiAgICAgICAgICAgIC8vIGFuZCBtYXhGaWxlU2l6ZSAoaW50ZWdlcikgdG8gbGltaXQgdGhlIGZpbGVzIHRvIGxvYWQ6XG4gICAgICAgICAgICBsb2FkSW1hZ2U6IGZ1bmN0aW9uIChkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuZGlzYWJsZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcyxcbiAgICAgICAgICAgICAgICAgICAgZmlsZSA9IGRhdGEuZmlsZXNbZGF0YS5pbmRleF0sXG4gICAgICAgICAgICAgICAgICAgIGRmZCA9ICQuRGVmZXJyZWQoKTtcbiAgICAgICAgICAgICAgICBpZiAoKCQudHlwZShvcHRpb25zLm1heEZpbGVTaXplKSA9PT0gJ251bWJlcicgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlLnNpemUgPiBvcHRpb25zLm1heEZpbGVTaXplKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgKG9wdGlvbnMuZmlsZVR5cGVzICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIW9wdGlvbnMuZmlsZVR5cGVzLnRlc3QoZmlsZS50eXBlKSkgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICFsb2FkSW1hZ2UoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoaW1nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbWcuc3JjKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmltZyA9IGltZztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZmQucmVzb2x2ZVdpdGgodGhhdCwgW2RhdGFdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnNcbiAgICAgICAgICAgICAgICAgICAgICAgICkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBkZmQucHJvbWlzZSgpO1xuICAgICAgICAgICAgfSxcblxuICAgICAgICAgICAgLy8gUmVzaXplcyB0aGUgaW1hZ2UgZ2l2ZW4gYXMgZGF0YS5jYW52YXMgb3IgZGF0YS5pbWdcbiAgICAgICAgICAgIC8vIGFuZCB1cGRhdGVzIGRhdGEuY2FudmFzIG9yIGRhdGEuaW1nIHdpdGggdGhlIHJlc2l6ZWQgaW1hZ2UuXG4gICAgICAgICAgICAvLyBBbHNvIHN0b3JlcyB0aGUgcmVzaXplZCBpbWFnZSBhcyBwcmV2aWV3IHByb3BlcnR5LlxuICAgICAgICAgICAgLy8gQWNjZXB0cyB0aGUgb3B0aW9ucyBtYXhXaWR0aCwgbWF4SGVpZ2h0LCBtaW5XaWR0aCxcbiAgICAgICAgICAgIC8vIG1pbkhlaWdodCwgY2FudmFzIGFuZCBjcm9wOlxuICAgICAgICAgICAgcmVzaXplSW1hZ2U6IGZ1bmN0aW9uIChkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuZGlzYWJsZWQgfHwgIShkYXRhLmNhbnZhcyB8fCBkYXRhLmltZykpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG9wdGlvbnMgPSAkLmV4dGVuZCh7Y2FudmFzOiB0cnVlfSwgb3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLFxuICAgICAgICAgICAgICAgICAgICBkZmQgPSAkLkRlZmVycmVkKCksXG4gICAgICAgICAgICAgICAgICAgIGltZyA9IChvcHRpb25zLmNhbnZhcyAmJiBkYXRhLmNhbnZhcykgfHwgZGF0YS5pbWcsXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUgPSBmdW5jdGlvbiAobmV3SW1nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3SW1nICYmIChuZXdJbWcud2lkdGggIT09IGltZy53aWR0aCB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdJbWcuaGVpZ2h0ICE9PSBpbWcuaGVpZ2h0IHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMuZm9yY2VSZXNpemUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVtuZXdJbWcuZ2V0Q29udGV4dCA/ICdjYW52YXMnIDogJ2ltZyddID0gbmV3SW1nO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5wcmV2aWV3ID0gbmV3SW1nO1xuICAgICAgICAgICAgICAgICAgICAgICAgZGZkLnJlc29sdmVXaXRoKHRoYXQsIFtkYXRhXSk7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIHRodW1ibmFpbDtcbiAgICAgICAgICAgICAgICBpZiAoZGF0YS5leGlmKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLm9yaWVudGF0aW9uID09PSB0cnVlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLm9yaWVudGF0aW9uID0gZGF0YS5leGlmLmdldCgnT3JpZW50YXRpb24nKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy50aHVtYm5haWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRodW1ibmFpbCA9IGRhdGEuZXhpZi5nZXQoJ1RodW1ibmFpbCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRodW1ibmFpbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRJbWFnZSh0aHVtYm5haWwsIHJlc29sdmUsIG9wdGlvbnMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkZmQucHJvbWlzZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIC8vIFByZXZlbnQgb3JpZW50aW5nIHRoZSBzYW1lIGltYWdlIHR3aWNlOlxuICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YS5vcmllbnRhdGlvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIG9wdGlvbnMub3JpZW50YXRpb247XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhLm9yaWVudGF0aW9uID0gb3B0aW9ucy5vcmllbnRhdGlvbjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoaW1nKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUobG9hZEltYWdlLnNjYWxlKGltZywgb3B0aW9ucykpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGZkLnByb21pc2UoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICAvLyBTYXZlcyB0aGUgcHJvY2Vzc2VkIGltYWdlIGdpdmVuIGFzIGRhdGEuY2FudmFzXG4gICAgICAgICAgICAvLyBpbnBsYWNlIGF0IGRhdGEuaW5kZXggb2YgZGF0YS5maWxlczpcbiAgICAgICAgICAgIHNhdmVJbWFnZTogZnVuY3Rpb24gKGRhdGEsIG9wdGlvbnMpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWRhdGEuY2FudmFzIHx8IG9wdGlvbnMuZGlzYWJsZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcyxcbiAgICAgICAgICAgICAgICAgICAgZmlsZSA9IGRhdGEuZmlsZXNbZGF0YS5pbmRleF0sXG4gICAgICAgICAgICAgICAgICAgIGRmZCA9ICQuRGVmZXJyZWQoKTtcbiAgICAgICAgICAgICAgICBpZiAoZGF0YS5jYW52YXMudG9CbG9iKSB7XG4gICAgICAgICAgICAgICAgICAgIGRhdGEuY2FudmFzLnRvQmxvYihcbiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChibG9iKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFibG9iLm5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbGUudHlwZSA9PT0gYmxvYi50eXBlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBibG9iLm5hbWUgPSBmaWxlLm5hbWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlsZS5uYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBibG9iLm5hbWUgPSBmaWxlLm5hbWUucmVwbGFjZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvXFwuXFx3KyQvLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcuJyArIGJsb2IudHlwZS5zdWJzdHIoNilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRG9uJ3QgcmVzdG9yZSBpbnZhbGlkIG1ldGEgZGF0YTpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlsZS50eXBlICE9PSBibG9iLnR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGRhdGEuaW1hZ2VIZWFkO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTdG9yZSB0aGUgY3JlYXRlZCBibG9iIGF0IHRoZSBwb3NpdGlvblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG9mIHRoZSBvcmlnaW5hbCBmaWxlIGluIHRoZSBmaWxlcyBsaXN0OlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuZmlsZXNbZGF0YS5pbmRleF0gPSBibG9iO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRmZC5yZXNvbHZlV2l0aCh0aGF0LCBbZGF0YV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMudHlwZSB8fCBmaWxlLnR5cGUsXG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnF1YWxpdHlcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRmZC5wcm9taXNlKCk7XG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICBsb2FkSW1hZ2VNZXRhRGF0YTogZnVuY3Rpb24gKGRhdGEsIG9wdGlvbnMpIHtcbiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5kaXNhYmxlZCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLFxuICAgICAgICAgICAgICAgICAgICBkZmQgPSAkLkRlZmVycmVkKCk7XG4gICAgICAgICAgICAgICAgbG9hZEltYWdlLnBhcnNlTWV0YURhdGEoZGF0YS5maWxlc1tkYXRhLmluZGV4XSwgZnVuY3Rpb24gKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICAkLmV4dGVuZChkYXRhLCByZXN1bHQpO1xuICAgICAgICAgICAgICAgICAgICBkZmQucmVzb2x2ZVdpdGgodGhhdCwgW2RhdGFdKTtcbiAgICAgICAgICAgICAgICB9LCBvcHRpb25zKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZGZkLnByb21pc2UoKTtcbiAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICAgIHNhdmVJbWFnZU1ldGFEYXRhOiBmdW5jdGlvbiAoZGF0YSwgb3B0aW9ucykge1xuICAgICAgICAgICAgICAgIGlmICghKGRhdGEuaW1hZ2VIZWFkICYmIGRhdGEuY2FudmFzICYmXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmNhbnZhcy50b0Jsb2IgJiYgIW9wdGlvbnMuZGlzYWJsZWQpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRhO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgZmlsZSA9IGRhdGEuZmlsZXNbZGF0YS5pbmRleF0sXG4gICAgICAgICAgICAgICAgICAgIGJsb2IgPSBuZXcgQmxvYihbXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmltYWdlSGVhZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlc2l6ZWQgaW1hZ2VzIGFsd2F5cyBoYXZlIGEgaGVhZCBzaXplIG9mIDIwIGJ5dGVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gaW5jbHVkaW5nIHRoZSBKUEVHIG1hcmtlciBhbmQgYSBtaW5pbWFsIEpGSUYgaGVhZGVyOlxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYmxvYlNsaWNlLmNhbGwoZmlsZSwgMjApXG4gICAgICAgICAgICAgICAgICAgIF0sIHt0eXBlOiBmaWxlLnR5cGV9KTtcbiAgICAgICAgICAgICAgICBibG9iLm5hbWUgPSBmaWxlLm5hbWU7XG4gICAgICAgICAgICAgICAgZGF0YS5maWxlc1tkYXRhLmluZGV4XSA9IGJsb2I7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICAvLyBTZXRzIHRoZSByZXNpemVkIHZlcnNpb24gb2YgdGhlIGltYWdlIGFzIGEgcHJvcGVydHkgb2YgdGhlXG4gICAgICAgICAgICAvLyBmaWxlIG9iamVjdCwgbXVzdCBiZSBjYWxsZWQgYWZ0ZXIgXCJzYXZlSW1hZ2VcIjpcbiAgICAgICAgICAgIHNldEltYWdlOiBmdW5jdGlvbiAoZGF0YSwgb3B0aW9ucykge1xuICAgICAgICAgICAgICAgIGlmIChkYXRhLnByZXZpZXcgJiYgIW9wdGlvbnMuZGlzYWJsZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgZGF0YS5maWxlc1tkYXRhLmluZGV4XVtvcHRpb25zLm5hbWUgfHwgJ3ByZXZpZXcnXSA9IGRhdGEucHJldmlldztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICBkZWxldGVJbWFnZVJlZmVyZW5jZXM6IGZ1bmN0aW9uIChkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFvcHRpb25zLmRpc2FibGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBkYXRhLmltZztcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGRhdGEuY2FudmFzO1xuICAgICAgICAgICAgICAgICAgICBkZWxldGUgZGF0YS5wcmV2aWV3O1xuICAgICAgICAgICAgICAgICAgICBkZWxldGUgZGF0YS5pbWFnZUhlYWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBkYXRhO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cblxuICAgIH0pO1xuXG59KSk7XG4iXX0=
